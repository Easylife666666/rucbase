# 数据库课程设计报告-李赫22331096

## 设计及测试报告：
### 存储管理：缓冲池管理器、记录管理器
#### 任务1.1 磁盘存储管理器
##### 功能概述
本任务要求补全`DiskManager`类，其负责读写指定页面、分配页面编号，以及对文件进行操作。  
##### 各功能模块的设计原理与实现方法
```cpp
void DiskManager::write_page(int fd, page_id_t page_no, const char *offset, int num_bytes)
void DiskManager::read_page(int fd, page_id_t page_no, char *offset, int num_bytes)
```
`write_page`与`read_page`做的操作均为先定位到文件头，然后再进行写入/读取的操作。
代码实现大概先使用`lseek`定位。再使用`open`/`close`函数读取磁盘句柄、输入/输出指针与输入/输出字符个数，同时检查输入/输出的字符数是否符合预期否则报错。
```cpp
void DiskManager::create_file(const std::string &path)
void DiskManager::destroy_file(const std::string &path)
int DiskManager::open_file(const std::string &path)
void DiskManager::close_file(int fd)
```
`create_file`,`destroy_file`,`open_file`,`close_file`均为对文件的处理。
`create_file`用于创建新文件，调用`open`函数。
`destroy_file`用于删除文件，使用`unlink`，即解除硬链接方式，解除到0也就相当于删除文件。
`open_file`用于打开文件，使用`open`函数，打开后在`path2fd_`、`fd2path_`中记录文件打开状态。
`close_file`用于关闭文件，使用`close`函数，关闭后删除`path2fd_`、`fd2path_`中记录的文件打开状态。
需要注意的是，在进行以上操作时，需要注意文件的存在性与文件是否打开的问题，文件是否存在可以使用文件内置`is_file`函数进行判断。文件打开与否通过在`path2fd_`、`fd2path_`中查找以进行判断。

##### 模块接口说明
`DiskManager`类的接口如下：
```cpp
class DiskManager {
   public:
    explicit DiskManager();        // Constructor
    ~DiskManager() = default;    // Destructor
    // 读写页面
    void write_page(int fd, page_id_t page_no, const char *offset, int num_bytes);
    void read_page(int fd, page_id_t page_no, char *offset, int num_bytes);
    // 对指定文件分配页面编号
    page_id_t allocate_page(int fd);
    // 文件操作
    bool is_file(const std::string &path);//确认文件是否存在
    void create_file(const std::string &path);//创建新的文件
    int open_file(const std::string &path);//打开文件
    void close_file(int fd);//关闭文件
    void destroy_file(const std::string &path);//删除文件
}
```
##### 测试结果
ikun@ikun-virtual-machine:~/Documents/rucbase/build/bin$ ./disk_manager_test
Running main() from /home/ikun/Documents/rucbase/deps/googletest/googletest/src/gtest_main.cc
[==========] Running 2 tests from 1 test suite.
[----------] Global test environment set-up.
[----------] 2 tests from DiskManagerTest
[ RUN      ] DiskManagerTest.FileOperation
[       OK ] DiskManagerTest.FileOperation (5 ms)
[ RUN      ] DiskManagerTest.PageOperation
[       OK ] DiskManagerTest.PageOperation (10 ms)
[----------] 2 tests from DiskManagerTest (15 ms total)

[----------] Global test environment tear-down
[==========] 2 tests from 1 test suite ran. (15 ms total)
[  PASSED  ] 2 tests.
ikun@ikun-virtual-machine:~/Documents/rucbase/build/bin$ 
##### 出现问题以及解决方法
1.发现部分量需要参考某些头文件。
例如：
src/config/config.h
PAGE_SIZE
src/config/disk_manager.h
path2fd_ fd2path_ fd2pageno_
2.发现部分错误返回需要参考某些头文件
例如：
errors.h
##### 源代码列表
src/storage/disk_manager.cpp

#### 任务1.2 缓冲池替换策略
##### 功能概述
本任务要求补全`Replacer`类，其负责跟踪缓冲池中每个页面所在帧的使用情况。当缓冲池没有空闲页面时，需要使用该类提供的替换策略选择一个页面进行淘汰。要求实现的替换策略为最近最少使用（LRU）算法。
##### 各功能模块的设计原理与实现方法
```cpp
bool LRUReplacer::victim(frame_id_t* frame_id)
void LRUReplacer::pin(frame_id_t frame_id) 
void LRUReplacer::unpin(frame_id_t frame_id)
```
注意需要保证每个函数都是原子性的操作，可以使用`std::mutex`对每个函数上锁。
`victim`用于淘汰掉一帧，通过`LRUlist_`，`LRUhash_`两个变量来实现LRU算法智能淘汰掉，使用较多的帧会排在前面，使用最少的帧会被淘汰。如果栈帧什么都没有，就返回一个空值并返回false。
`pin`用于固定一帧，将这一帧从`LRUlist_`，`LRUhash_`中移除。
`unpin`用于解除固定一帧，将这一帧加入`LRUlist_`，`LRUhash_`。
##### 模块接口说明
```cpp
class Replacer {
   public:
    explicit Replacer(size_t num_pages);
    ~Replacer();
    bool victim(frame_id_t *frame_id);//淘汰一帧
    void pin(frame_id_t frame_id);//固定一帧
    void unpin(frame_id_t frame_id);//取消固定一帧
};
```
##### 测试结果
easylife@Victus:~/Documents/rucbase/build/bin$ ./lru_replacer_test
Running main() from /home/easylife/Documents/rucbase/deps/googletest/googletest/src/gtest_main.cc
[==========] Running 3 tests from 1 test suite.
[----------] Global test environment set-up.
[----------] 3 tests from LRUReplacerTest
[ RUN      ] LRUReplacerTest.SimpleTest
[       OK ] LRUReplacerTest.SimpleTest (0 ms)
[ RUN      ] LRUReplacerTest.MixTest
[       OK ] LRUReplacerTest.MixTest (8 ms)
[ RUN      ] LRUReplacerTest.ConcurrencyTest
[       OK ] LRUReplacerTest.ConcurrencyTest (73 ms)
[----------] 3 tests from LRUReplacerTest (82 ms total)

[----------] Global test environment tear-down
[==========] 3 tests from 1 test suite ran. (82 ms total)
[  PASSED  ] 3 tests.
easylife@Victus:~/Documents/rucbase/build/bin$ 
##### 出现问题以及解决方法
##### 源代码列表
src/replacer/lru_replacer.cpp

#### 任务1.3 缓冲池管理器
##### 功能概述
本任务要求补全`BufferPoolManager`类，其负责管理缓冲池中的页面与磁盘文件中的页面之间的来回移动。
##### 各功能模块的设计原理与实现方法
##### 模块接口说明
##### 测试结果
##### 出现问题以及解决方法
##### 源代码列表

#### 任务2.1 记录操作
##### 功能概述
##### 各功能模块的设计原理与实现方法
##### 模块接口说明
##### 测试结果
##### 出现问题以及解决方法
##### 源代码列表

#### 任务2.2 记录迭代器
##### 功能概述
##### 各功能模块的设计原理与实现方法
##### 模块接口说明
##### 测试结果
##### 出现问题以及解决方法
##### 源代码列表

## 源代码
### rucbase目录下均为源代码，这里举出修改过的代码目录：
src/storage/disk_manager.cpp

## 系统设计总结
1

## 课程总结
1